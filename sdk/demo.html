<html>
<head>
    <title>Clock</title>
    <script src="../demo/javascript/dist/webim.config.js"></script>
    <script src="./dist/strophe-1.2.8.min.js"></script>
    <script src="./dist/websdk-1.4.6.js"></script>
</head>
<body>

<h2>Text Box</h2>
<div>
    <input type="text" id="text">
</div>

<h2>Private</h2>
<div>
    <button id="register">Register</button>
    <button id="privateText">PrivateText</button>
    <button id="privateCmd">PrivateCmd</button>
    <div>
        <br>
        image: <input type="file" id="image">
        <button id="privateImg">PrivateImg</button>
    </div>
    <br>
</div>

<h2>ChatRoom</h2>
<div>
    <button id="roomJoin">JoinRoom</button>
    <button id="roomText">RoomText</button>
    <button id="roomQuit">RoomQuit</button>
    <button id="listChatRooms">ListChatRooms</button>
</div>

<h2>Group</h2>
<div>
    <button id="groupCreate">GroupCreate</button>
    <button id="groupText">GroupText</button>
    <button id="groupMember">GroupMember</button>
    <button id="queryGroupInfo">QueryGroupInfo</button>
    <button id="leaveGroup">LeaveGroup</button>
    <button id="addToGroupBlackList">AddToGroupBlackList</button>
    <button id="listGroups">ListGroups</button>
    <button id="changeGroupInfo">ChangeGroupInfo</button>
    <button id="getGroupBlackList">GetGroupBlackList</button>
    <button id="destroyGroup">DestroyGroup</button>
    <button id="addGroupMembers">AddGroupMembers</button>
    <button id="removeGroupMemberFromBlackList">RemoveGroupMemberFromBlackList</button>
</div>

<h3>Roasters</h3>
<div>
    <button id="getRoasters">GetRoasters</button>
    <button id="addFriends">AddFriends</button>
    <button id="agreeFriends">AgreeFriends</button>
    <button id="rejectFriends">RejectFriends</button>
    <button id="removeRoster">RemoveRoster</button>
    <button id="addToBlackList">AddToBlackList</button>
    <button id="getBlackList">GetBlackList</button>
    <button id="removeFromBlackList">RemoveFromBlackList</button>
</div>

<script>
    /**
     * Created by clock on 16-11-25.
     */

    /*
    	Connection
    */
     
    var conn = new WebIM.connection({
        isMultiLoginSessions: WebIM.config.isMultiLoginSessions,
        https: typeof WebIM.config.https === 'boolean' ? WebIM.config.https : location.protocol === 'https:',
        url: WebIM.config.xmppURL,
        isAutoLogin: true,
        heartBeatWait: WebIM.config.heartBeatWait,
        autoReconnectNumMax: WebIM.config.autoReconnectNumMax,
        autoReconnectInterval: WebIM.config.autoReconnectInterval
    });

    // callback listening
    conn.listen({
        onOpened: function (message) {          // connection established callback. Can only send message if connection established
            // If set isAutoLogin=false, then must re-login manually
            // Manually login using conn.setPresence(); in this example, conn init has isAutoLogin=true so no need to call conn.setPresence();
            console.log("opened");
        },
        onTextMessage: function (message) {
            // process the message respect to its message.type. one-to-one chat, group chat, or chat room
            console.log(message.type);
            console.log('Text');
        }, // text message received
        onEmojiMessage: function (message) {
            // If WebIM has Emoji property, then connection will translate the character string to corresponding emojin in WebIM.Emoji automatically
            // the key-value structure is {type: 'emoji(or txt)', data:''}
            // If type='emoji', data represent the path to emoji. If type='txt', data is text message
            console.log('Emoji');
            var data = message.data;
            for(var i = 0 , l = data.length ; i < l ; i++){
                console.log(data[i]);
            }
        }, // Emoji message received
        onPictureMessage: function (message) {
            console.log('Picture');

            var options = {url: message.url};
            options.onFileDownloadComplete = function () {
                console.log('Image download complete!');
            };
            options.onFileDownloadError = function () {
                console.log('Image download failed!');
            };

        }, // image message received
        onCmdMessage: function (message) {
            console.log('CMD');
        }, // command message received
        onAudioMessage: function (message) {
            console.log("Audio");
        }, // audio message received
        onLocationMessage: function (message) {
            console.log("Location");
        }, // location message received
        onFileMessage: function (message) {
            console.log("File");
        }, // file received
        onVideoMessage: function (message) {
            console.log("Video");
        }, // video message received
        onPresence: function (message) {
            switch (message.type) {
                case 'subscribe':                           // receiving user receives friend request
                    // receiving user accepts friend request
                    document.getElementById('agreeFriends').onclick = function (message) {
                        conn.subscribed({
                            to: 'orange',
                            message: "[resp:true]"
                        });
                        // need to send receiving user friend request
                        conn.subscribe({
                            to: message.from,
                            message: "[resp:true]"
                        });
                    };
                    // receiving user declines friend request
                    document.getElementById('rejectFriends').onclick = function (message) {
                        conn.unsubscribed({
                            to: message.from,
                            message: "rejectAddFriend"                  
                        });
                    };

                    break;
                case 'subscribed':                          // receiving user accepted friend request. requesting user accepts friend request
                    break;
                case 'unsubscribe':                         // receiving user remove friend
                    break;
                case 'unsubscribed':                        // receiving user declined friend request. requesting user declines friend request
                    break;
                case 'joinChatRoomSucceed':                 // join chat room succeed
                    console.log('join chat room succeed');
                    break;
                case 'joinChatRoomFailed':                   // join chat room failed
                    console.log('join chat room failed');
                    break;
                case 'joinPublicGroupSuccess':              // join public group success
                    console.log('join public group success', message.from);
                    break;
            }
        },  // receive friend request, group and chat room related updates
        onRoster: function (message) {
            console.log('Roster');
        }, // receive invitation
        onInviteMessage: function (message) {
            console.log('Invite');
        },  // receive group invitation
        onOnline: function () {
            console.log('onLine');
        }, // connection established
        onOffline: function () {
            console.log('offline');
        }, // connection dropped
        onError: function (message) {
            console.log('Error');
        }, // callback failed
        onBlacklistUpdate: function (list) {
            // list contains list of user info from the blacklist
            console.log(list);
        } // update blacklist succeed
    });
</script>

<script>
	
	// open, login
    var options = {
        apiUrl: WebIM.config.apiURL,
        user: "orange",
        pwd: "password",
        appKey: WebIM.config.appkey
    };
    conn.open(options);

    var register = function () {
        var option = {
            username: 'apple',
            password: 'password',
            nickname: 'clock',
            appKey: WebIM.config.appkey,
            success: function () {
                console.log('registration succeed!');
            },
            error: function () {
                console.log('registration error');
            },
            apiUrl: WebIM.config.apiURL
        };
        conn.signup(option);
    };

    /*
    	One-to-One Messaging 
    */

    // Send a text message or emoji message. The characters associated with emoji will be translated to emoji automatically.
    var sendPrivateText = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        msg.set({
            msg: 'good morning!',                       // message content
            to: 'orange',                             // receiver
            roomType: false,
            success: function (id, serverMsgId) {
                console.log("send private text Succeed");
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
    };

    // send command message
    var sendPrivateCmd = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('cmd', id);
        msg.set({
            msg: 'ls',
            to: 'orange',
            roomType: false,
            success: function (id, serverMsgId) {
                console.log('send private CMD Succeed');
            }
        });
        msg.body.chatType = 'singleChat';
        conn.send(msg.body);
    };

    // send image message
    var sendPrivateImg = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('img', id);
        var input = document.getElementById('image');               // get image input
        var file = WebIM.utils.getFileUrl(input);                   // convert image to binary file
        var allowType = {
            'jpg': true,
            'gif': true,
            'png': true,
            'bmp': true
        };
        if (file.filetype.toLowerCase() in allowType) {
            console.log('send');
            var option = {
                apiUrl: WebIM.config.apiURL,
                file: file,
                to: 'orange',
                roomType: false,
                chatType: 'singleChat',
                onFileUploadError: function () {
                    console.log('onFileUploadError');
                },
                onFileUploadComplete: function () {
                    console.log('onFileUploadComplete');
                },
                success: function () {
                    console.log('send image succeed');
                },
            };
            msg.set(option);
            conn.send(msg.body);
        }
    };

    // get a list of friends (roster)
    var getRoasters = function () {
        var option = {
            success: function (roster) {
                for (var o in roster) {
                    console.log("jid: ", roster[o].jid);
                    console.log("name: ", roster[o].name);
                    console.log("subscription: ", roster[o].subscription);
                }
            }
        };
        conn.getRoster(option);
    };
	/* The format of roster
	[
		{
			jid:"hyphenate#chatdemoui_apple@hyphenate.io",
			name:"apple",
			subscription: "both"	                 // both, to, from, none
			// subscription values {both, to, from, none}
			// both: users are friends
			// to and from: undefined
			// none: users are not friends
		}
	]
	*/

    // Add friend
    var addFriends = function () {
        conn.subscribe({
            to: "orange",
            message: "hello orange!"                   
        });
    };

    // remove friend
    var removeFriends = function () {
        conn.removeRoster({
            to: 'orange',
            success: function () {
                conn.unsubscribed({
                    to: 'orange'
                });
            },
            error: function () {
            }
        });
    };
	
    // If user A blocks user B, user A can still see user B, but user B is unable to sent message to user A.

    // The structure of a list {username_1: {}, username_2: {} ...}. If you want to add user C to the blacklist already contains user A and B, then pass user A, B, and C to the function. 

	// The parameters, jid, username, and subscription, will be obtained during getting contact list. User can obtain list of contact respect to the parameters above. However, do not repeat the parameter, `order`.
	
	/*
	 var list = {
	     username_1:{
	         jid: 'apiKey_'+username_1+'@hyphenate.io',
	         name: username_1,
	         subscription: 'both',
	         order: 2
	     },
	     username_2:{
	         jid: 'apiKey_'+username_2+'@hyphenate.io',
	         name: username_2,
	         subscription: 'both',
	         order: 3,
	         type: 'jid'
	     },
	     username_3:{
	         jid: 'apiKey_'+username_3+'@hyphenate.io',
	         name: username_3,
	         subscription: 'both',
	         order: 4,
	         type: 'jid'
	     }
	 }
	*/
	
    var addToBlackList = function () {
        var list = {
            // user_1
            orange: {
                jid: "hyphenate-demo#chatdemoui_orange@hyphenate.io",
                name: "orange",
                subscription: 'both',
                order: 2,
                type: 'jid'
            },
            // user_2
            apple: {
                jid: "hyphenate-demo#chatdemoui_apple@hyphenate.io",
                name: "apple",
                subscription: 'both',
                order: 3,
                type: 'jid'
            }
        };
        conn.addToBlackList({
            list: list,
            type: 'jid',
            success: function () {
                console.log('Add friend to blacklist succeed');
            },
            error: function () {
                console.log('Add friend to blacklist failed');
            }
        });
    }

	// Use the function getBlacklist to get the blacklist. Once completed, expect to receive variable onBlacklistUpdate from callback function conn.listen. Please see [Basic Operations](doc:web-basic-operations) for further details.    var getBlackList = function () {
        conn.getBlacklist();
    };

    // remove user from blacklist
    var removeFromBlackList = function () {
        var list = {};
        conn.removeFromBlackList({
            list: list,
            type: 'jid',
            success: function () {
                console.log('Remove from blacklist success.');
            },
            error: function () {
                console.log('Remove from blacklist error.')
            }
        });
    };


	/* 
		Chat Room 
	*/

    // send text mssage
    var sendRoomText = function () {
        // leave chat room
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var option = {
            msg: 'good morning!',                       // message content
            to: '114715680632209992',                   // receiver. chat room ID
            roomType: true,
            chatType: 'chatRoom',
            success: function () {
                console.log('send room text succeed');
            },
            fail: function () {
                console.log('failed');
            }
        };
        msg.set(option);
        msg.setGroup('groupchat');
        conn.send(msg.body);
    };
    // join chat room
    var joinRoom = function () {
        conn.joinChatRoom({
            roomId: "114715680632209992"
        });
    };
    // leave chat room
    var quitRoom = function () {
        conn.quitChatRoom({
            roomId: "114715680632209992"
        });
    };
    // list all the chat rooms with pagination
    var listRooms = function () {
        var option = {
            apiUrl: 'https://a1.hyphenate.io',
            pagenum: 1,                                 // page index
            pagesize: 20,                               // number of items on the page
            success: function (list) {
                console.log(list);
            },
            error: function () {
                console.log('List chat room error');
            }
        };
        conn.getChatRooms(option);
    }
    
    // query chat room member info, the same applies to query group member
    // the resutl of querying structure, {affiliation: 'member', jid: "hyphenatedemo#chat@hyphenate.io"}
    // It's in jid format. jid:'{api key}' + '_' + {username} + '@hyphenate.io'
    var queryRoomMember = function () {
        var member = '';
        conn.queryRoomMember({
            roomId: '114715680632209992',
            success: function (members) {
                for (var o in members) {
                    member = members[o];
                    console.log(member);
                }
            }
        });
    };


	/* 
		Group Chat 
	*/
	
    // send message
    var sendGroupText = function () {
        var id = conn.getUniqueId();
        var msg = new WebIM.message('txt', id);
        var option = {
            msg: 'good morning!',                       // message content
            to: '1480567165764',                     	// receiver. group id.
            roomType: false,
            chatType: 'chatRoom',
            success: function () {
                console.log('send room text succeed');
            },
            fail: function () {
                console.log('failed');
            }
        };
        msg.set(option);
        msg.setGroup('groupchat');
        conn.send(msg.body);
    };
    // Create a group
    var createGroup = function () {
        var option = {
            subject: 'groupName',                       // group name
            description: 'create a group test',         // group description
            members: ['apple', 'orange'],               // list to user to be added to group
            optionsPublic: true,                        // allow any user to joing
            optionsModerate: false,                     // require permission to join
            optionsMembersOnly: false,                  // require invitation to join
            optionsAllowInvites: false                  // allow member to invite
        };
        conn.createGroup(option);
    }
    // get group info
    var queryGroupInfo = function () {
        conn.queryRoomInfo({
            roomId: '1480747027186',
            success: function (settings, members, fields) {
                console.log('settings: ', settings);
                console.log('members: ', members);
                console.log('fields: ', fields);
            },
            error: function () {
                console.log('Error!');
            }
        });
    };
    /*
    // settings: The permission to join the group. (pending definition)
    // members[0] contains the group owner info in the following structure
    // {affiliation: "owner", jid: appKey + "_" + username + "@hyphenate.io"}
    // jid username is admin's user ID
    // field
	 {
		 affiliations: "2",                  
		 description: "12311231313",         // Group description
		 maxusers: "200",                    // Group capacity
		 name: "123",                        // Group name
		 occupants: "2",                     // number of group members
		 owner: "hyphenatedemo#chat"         // Group ID as jid
	 }
 	*/
 	
    // add users to group
    var addGroupMembers = function () {
        var option = {
            list: ['orange', 'apple'],
            roomId: '1480841456167'
        };
        conn.addGroupMembers(option);
    };
    // member leaves group
    var leaveGroup = function () {
        var option = {
            to: 'orange',
            roomId: '1480747027186',
            success: function () {
                console.log('You leave room succeed!');
            },
            error: function () {
                console.log('Leave room faild');
            }
        };
        conn.leaveGroupBySelf(option);
    };
    // list all the groups
    var listGroups = function () {
        var option = {
            success: function (rooms) {
                console.log(rooms);
            },
            error: function () {
                console.log('List chat rooms error');
            }
        };
        conn.listRooms(option);
    };
    // query chat room member info, the same applies to query group member
    // the resutl of querying structure, {affiliation: 'member', jid: "hyphenatedemo#chat@hyphenate.io"}
    // It's in jid format. jid:'{api key}' + '_' + {username} + '@hyphenate.io'
    var queryRoomMember = function () {
        var member = '';
        conn.queryRoomMember({
            roomId: '114715680632209992',
            success: function (members) {
                for (var o in members) {
                    member = members[o];
                    console.log(member);
                }
            }
        });
    };
    // update gorup info
    var changeGroupInfo = function () {
        var option = {
            roomId: '1480756943693',
            subject: 'ChangeTest',
            description: 'Change group information test',
            success: function () {
                console.log("Change Group Names Success!");
            }
        };
        conn.changeGroupSubject(option);
    };
    // get group blacklist
    var getGroupBlackList = function () {
        var option = {
            roomId: '1480758709661',
            success: function (list) {
                console.log('Get group blacklist: ', list);
            },
            error: function () {
                console.log('Get group blacklist error');
            }
        };
        conn.getGroupBlacklist(option);
    };
    // remove member from group and add the member to blacklist
    var addToGroupBlackList = function () {
        var option = {
            affiliation: "owner",                       // default value. Do not alter. 
            roomId: "1480756943693",                    // group ID
            success: function () {
                console.log('add to blacklist succeed');
            },
            to: 'orange'                               // user ID of the member to be removed
        };
        conn.addToGroupBlackList(option);
    };
    // remove users from blacklist
    var removeFromGroupBlackList = function () {
        var option = {
            roomId: '1480841456167',
            to: 'apple',
            success: function () {
                console.log('Remove from blacklist succeed!');
            }
        };
        conn.removeGroupMemberFromBlacklist(option);
    };
    // destroy group 
    var destroyGroup = function () {
        var option = {
            reason: 'Test Destroy Group',
            roomId: '1480840256052',
            success: function () {
                console.log('Destroy group succeed!');
            }
        };
        conn.destroyGroup(option);
    };

</script>

<script>
    window.onload = function () {
        document.getElementById('register').onclick = register;
        document.getElementById('privateText').onclick = sendPrivateText;
        document.getElementById('privateCmd').onclick = sendPrivateCmd;
        document.getElementById('privateImg').onclick = sendPrivateImg;
        document.getElementById('getBlackList').onclick = getBlackList;
        document.getElementById('addToBlackList').onclick = addToBlackList;
        document.getElementById('removeFromBlackList').onclick = removeFromBlackList;

        document.getElementById('roomText').onclick = sendRoomText;
        document.getElementById('roomJoin').onclick = joinRoom;
        document.getElementById('roomQuit').onclick = quitRoom;
        document.getElementById('listChatRooms').onclick = listRooms;

        document.getElementById('groupText').onclick = sendGroupText;
        document.getElementById('groupMember').onclick = queryRoomMember;
        document.getElementById('groupCreate').onclick = createGroup;
        document.getElementById('queryGroupInfo').onclick = queryGroupInfo;
        document.getElementById('leaveGroup').onclick = leaveGroup;
        document.getElementById('addToGroupBlackList').onclick = addToGroupBlackList;
        document.getElementById('listGroups').onclick = listGroups;
        document.getElementById('changeGroupInfo').onclick = changeGroupInfo;
        document.getElementById('getGroupBlackList').onclick = getGroupBlackList;
        document.getElementById('destroyGroup').onclick = destroyGroup;
        document.getElementById('addGroupMembers').onclick = addGroupMembers;
        document.getElementById('removeGroupMemberFromBlackList').onclick = removeFromGroupBlackList;

        document.getElementById('getRoasters').onclick = getRoasters;
        document.getElementById('addFriends').onclick = addFriends;
        document.getElementById('removeRoster').onclick = removeFriends;
    };
</script>

<script>
    // send image
    document.addEventListener('paste', function (e) {
        if (e.clipboardData && e.clipboardData.types) {
            if (e.clipboardData.items.length > 0) {
                if (/^image\/\w+$/.test(e.clipboardData.items[0].type)) {
                    var blob = e.clipboardData.items[0].getAsFile();
                    var url = window.URL.createObjectURL(blob);
                    var id = conn.getUniqueId(); 		// create local message id

                    var msg = new WebIM.message('img', id);
                    msg.set({
                        apiUrl: WebIM.config.apiURL,
                        file: {data: blob, url: url},
                        to: 'orange',
                        roomType: false,
                        chatType: 'singleChat',
                        onFileUploadError: function (error) {
                            console.log("Error");
                        },
                        onFileUploadComplete: function (data) {
                            console.log("Complete");
                        },
                        success: function (id) {
                            console.log("Success");
                        }
                    });
                    conn.send(msg.body);
                }
            }
        }
    });
</script>
</body>
</html>